@page "/checkout"

@using AstroOfficeWeb.Services
@using AstroOfficeWeb.Shared.Utilities
@using static AstroOfficeWeb.Components.CustomFormInputs.InputSelect2<long>

@inject ProductService ProductService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject StripePayment StripePayment
@inject CountryService CountryService


<ViewAddressModal @ref="Modal_ViewAddress" Addresses="Addresses" OnSelectAddressChanged="OnSelect_Address" CountryOptions="CountryOptions"></ViewAddressModal>

<div class="container-fluid p-3">
    <h1 class="pt-4 pb-2 font-weight-bold "> Checkout </h1>
    <section class="content">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-xl-8">
                                <div id="checkout-nav-pills-wizard" class="twitter-bs-wizard form-wizard-header">
                                    <ul class="twitter-bs-wizard-nav mb-2 nav nav-pills nav-justified">
                                        <li class="nav-item">
                                            <a @ref="ER_ABillingInfo" href="#billing-info" class="nav-link active" data-bs-toggle="tab" data-toggle="tab" @onclick="()=>ProceedCheckoutNavPills(ProceedStatus.Billing)">
                                                <span class="number">01</span>
                                                <span class="d-none d-sm-inline">Billing Info</span>
                                            </a>
                                        </li>

                                        @if (BillingInfo.ShipToDifferentAddress)
                                        {
                                            <li class="nav-item">
                                                <a @ref="ER_AShippingInfo" href="#shipping-info" class="nav-link" data-bs-toggle="tab" data-toggle="tab" @onclick="()=>ProceedCheckoutNavPills(ProceedStatus.Shipping)">
                                                    <span class="number">02</span>
                                                    <span class="d-none d-sm-inline">Shipping Info</span>
                                                </a>
                                            </li>
                                        }

                                        <li class="nav-item">
                                            <a @ref="ER_APaymentInfo" href="#payment-info" class="nav-link" data-bs-toggle="tab" data-toggle="tab" @onclick="()=>ProceedCheckoutNavPills(ProceedStatus.Payment)">
                                                <span class="number"> @(BillingInfo.ShipToDifferentAddress ? "03" : "02")</span>
                                                <span class="d-none d-sm-inline">Payment Info</span>
                                            </a>
                                        </li>
                                    </ul>

                                    <div class="tab-content twitter-bs-wizard-tab-content">
                                        <div class="tab-pane active" id="billing-info">
                                            <EditForm EditContext="BillingInfoContext" OnValidSubmit="OnSubmit_BillingInfo">
                                                <DataAnnotationsValidator />
                                                <div>
                                                    <h4 class="header-title d-inline">Billing Information</h4>
                                                    <div class="float-end">
                                                        <button class="btn btn-secondary" type="button" @onclick="()=>OnClick_BtnChangeAddress(0)">
                                                            <i class="fa-regular fa-pen-to-square"></i> Change
                                                        </button>
                                                    </div>
                                                    <p class="sub-header">
                                                        Fill the form below in order to
                                                        send you the order's invoice.
                                                    </p>


                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="billing-first-name" class="form-label">First Name</label> <span class="text-danger">*</span>
                                                                <ValidationMessage For=@(() => BillingInfo!.FirstName) style="position:revert;" />
                                                                <InputText @bind-Value="BillingInfo!.FirstName" class="form-control" type="text" placeholder="Enter your first name" id="billing-first-name" />
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="billing-last-name" class="form-label">Last Name</label> <span class="text-danger">*</span>
                                                                <ValidationMessage For=@(() => BillingInfo!.LastName) style="position:revert;" />
                                                                <InputText @bind-Value="BillingInfo!.LastName" class="form-control" type="text" placeholder="Enter your last name" id="billing-last-name" />
                                                            </div>
                                                        </div>
                                                    </div> <!-- end row -->
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="billing-email-address" class="form-label">Email Address <span class="text-danger">*</span></label>
                                                                <ValidationMessage For=@(() => BillingInfo!.Email) style="position:revert;" />
                                                                <InputText @bind-Value="BillingInfo!.Email" class="form-control" type="email" placeholder="Enter your email" id="billing-email-address" />
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="billing-phone" class="form-label mb-1">Phone <span class="text-danger">*</span></label>
                                                                <ValidationMessage For=@(() => BillingInfo!.PhoneNumber) style="position:revert;" />
                                                                @* <InputMask IType="string" Mask="999 999 9999" @bind-Value="BillingInfo!.PhoneNumber" class="form-control" id="billing-phone" /> *@

                                                                <MudTextField @bind-Value="BillingInfo!.PhoneNumber" Variant="Variant.Outlined" Mask="@(new PatternMask("0000000000"))" Class="form-control " Margin="Margin.Dense" Placeholder="Mobile No." />
                                                            </div>
                                                        </div>
                                                    </div> <!-- end row -->
                                                    <div class="row">
                                                        <div class="col-12">
                                                            <div class="mb-3">
                                                                <label for="billing-address" class="form-label">Address 1</label>
                                                                <ValidationMessage For=@(() => BillingInfo!.AddressLine1) style="position:revert;" />
                                                                <InputText @bind-Value="BillingInfo!.AddressLine1" class="form-control" type="text" placeholder="Enter full address" id="billing-address" />
                                                            </div>
                                                        </div>
                                                    </div> <!-- end row -->

                                                    <div class="row">
                                                        <div class="col-12">
                                                            <div class="mb-3">
                                                                <label for="billing-address" class="form-label">Address 2</label>
                                                                <ValidationMessage For=@(() => BillingInfo!.AddressLine2) style="position:revert;" />
                                                                <InputText @bind-Value="BillingInfo!.AddressLine2" class="form-control" type="text" placeholder="Enter full address" id="billing-address" />
                                                            </div>
                                                        </div>
                                                    </div> <!-- end row -->
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="billing-town-city" class="form-label">Town / City</label>
                                                                <ValidationMessage For=@(() => BillingInfo!.City) style="position:revert;" />
                                                                <InputText @bind-Value="BillingInfo!.City" class="form-control" type="text" placeholder="Enter your city name" id="billing-town-city" />
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="billing-state" class="form-label">State</label>
                                                                <ValidationMessage For=@(() => BillingInfo!.State) style="position:revert;" />
                                                                <InputText @bind-Value="BillingInfo!.State" class="form-control" type="text" placeholder="Enter your state" id="billing-state" />
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="billing-zip-postal" class="form-label mb-1">Zip Code</label>
                                                                <ValidationMessage For=@(() => BillingInfo!.ZipCode) style="position:revert;" />
                                                                @* <MudTextField T="string" @bind-Value="BillingInfo!.ZipCode" Required="true" RequiredError="Zip code is required!" Mask="@(new PatternMask("00 0000 0000"))" Placeholder="Enter zip code"/> *@
                                                                <MudTextField @bind-Value="BillingInfo!.ZipCode" Variant="Variant.Outlined" Mask="@(new PatternMask("0000 000"))" Class="form-control " Margin="Margin.Dense" Placeholder="Enter zip code" />
                                                                @* <InputMask IType="string" @bind-Value="BillingInfo!.ZipCode" Mask="999 999" class="form-control" placeholder="Enter your zip code" id="billing-zip-postal" /> *@
                                                            </div>
                                                        </div>
                                                    </div> <!-- end row -->
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="billing-landmark" class="form-label">Landmark</label>
                                                                <ValidationMessage For=@(() => BillingInfo!.Landmark) style="position:revert;" />
                                                                <InputText @bind-Value="BillingInfo!.Landmark" class="form-control" type="text" placeholder="Enter your Landmark" id="billing-landmark" />
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label">Country</label>
                                                                <ValidationMessage For=@(() => BillingInfo!.ACountrySno) style="position:revert;" />
                                                                <InputSelect2 @bind-Value="BillingInfo!.ACountrySno" class="form-control" Placeholder="Select a Country" Options="CountryOptions" />
                                                            </div>
                                                        </div>
                                                    </div> <!-- end row -->

                                                    <div class="row">
                                                        <div class="col-12">
                                                            <div class="mb-3">
                                                                <div class="form-check">
                                                                    <InputCheckbox @bind-Value="BillingInfo.ShipToDifferentAddress" class="form-check-input" type="checkbox" id="shipdifferent-check" />
                                                                    <label class="form-check-label" for="shipdifferent-check">Ship to different address ?</label>
                                                                </div>
                                                            </div>

                                                            <div class="mb-3 mt-3">
                                                                <label for="example-textarea" class="form-label">Order Notes:</label>
                                                                <textarea @bind="PlaceOrder.OrderNotes" class="form-control" id="example-textarea" rows="3" placeholder="Write some note.."></textarea>
                                                            </div>
                                                        </div>
                                                    </div> <!-- end row -->

                                                </div>
                                                <div class="d-flex mb-3">
                                                    <div class="mb-2">
                                                        <a href="shopping-cart" class="btn btn-custom"><i class="fas fa-arrow-left mx-2"></i> Back <span class="d-none d-md-inline-block">to Shopping Cart</span> </a>
                                                    </div>
                                                    <div class="ml-auto">
                                                        <button class="btn btn-success" type="submit"><i class="fas fa-truck mx-2"></i> Update<span class="d-none d-md-inline-block"> BillingInfo & @(BillingInfo.ShipToDifferentAddress ? "Proceed to Shipping" : "Proceed to Payment ") </span></button>
                                                    </div>
                                                </div>

                                            </EditForm>
                                        </div>

                                        @if (BillingInfo.ShipToDifferentAddress)
                                        {
                                            <div class="tab-pane" id="shipping-info">
                                                <div>
                                                    <h4 class="header-title">Saved Address</h4>

                                                    <p class="sub-header">
                                                        Fill the form below in order to
                                                        send you the order's invoice.
                                                    </p>

                                                    <div class="row">

                                                        @foreach (var address in ShippingAddresses)
                                                        {
                                                            <div class="col-md-6">
                                                                <div class="border p-3 rounded mb-3 mb-md-0">

                                                                    <div class="form-check form-check-inline font-16">
                                                                        <input class="form-check-input" type="radio" name="ShippingAddress" id=@($"{address.AddressType}{address.Sno}") @onchange="@(() => PlaceOrder.ShippingAddressSno = address.Sno)" />
                                                                        <label class="form-check-label" for=@($"{address.AddressType}{address.Sno}")>@address.AddressType</label>
                                                                    </div>

                                                                    <div class="float-end d-inline">
                                                                        <a href="#"><i class="fas fa-edit text-muted font-20"></i></a>
                                                                    </div>
                                                                    <h5 class="mt-3">@address.FullName</h5>

                                                                    <p class="mb-1"><span class="fw-semibold me-2">Address:</span> @address.AddressLine1</p>
                                                                    @* <p class="mb-1"><span class="fw-semibold me-2">Phone:</span> (123) 456-7890</p> *@
                                                                    <p class="mb-0"><span class="fw-semibold me-2">Mobile:</span> @address.PhoneNumber</p>
                                                                </div>
                                                            </div>
                                                        }



                                                      
                                                    </div>
                                                    <!-- end row-->

                                                    <h4 class="header-title mt-4">Shipping Method</h4>

                                                    <p class="text-muted mb-3">
                                                        Fill the form below in order to
                                                        send you the order's invoice.
                                                    </p>

                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="border p-3 rounded mb-3">
                                                                <div class="form-check form-check-inline font-16 mb-0">
                                                                    <input class="form-check-input" type="radio" name="shippingMethod" id="shippingMethodRadio1" checked="">
                                                                    <label class="form-check-label" for="shippingMethodRadio1">Standard Delivery - FREE</label>
                                                                </div>

                                                                <p class="mb-0 ps-3 pt-1">Estimated 5-7 days shipping (Duties and tax may be due upon delivery)</p>
                                                            </div>

                                                            <div class="border p-3 rounded">
                                                                <div class="form-check form-check-inline font-16 mb-0">
                                                                    <input class="form-check-input" type="radio" name="shippingMethod" id="shippingMethodRadio2">
                                                                    <label class="form-check-label" for="shippingMethodRadio2">Fast Delivery - $25</label>
                                                                </div>
                                                                <p class="mb-0 ps-3 pt-1">Estimated 1-2 days shipping (Duties and tax may be due upon delivery)</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- end row-->
                                                </div>

                                                <div class="d-flex my-3">
                                                    <div class="">
                                                        <button class="btn btn-custom" type="button" @onclick="()=>OnClick_BtnProceed(ProceedStatus.Billing)"><i class="fas fa-arrow-left mx-2"></i> Back to Billing </button>
                                                    </div>
                                                    <div class="ml-auto">
                                                        <button class="btn btn-success" type="button" @onclick="()=>OnClick_BtnProceed(ProceedStatus.Payment)"><i class="fas fa-money-bill"></i> Continue to Payment </button>
                                                    </div>
                                                </div>

                                            </div>
                                        }

                                        <div class="tab-pane" id="payment-info">
                                            <div>
                                                <h4 class="header-title">Payment Selection</h4>

                                                <p class="sub-header">
                                                    Fill the form below in order to
                                                    send you the order's invoice.
                                                </p>

                                                <!-- Pay with stripe box-->

                                                <div class="border p-3 mb-3 rounded">
                                                    <div class="float-end">
                                                        <i class="fab fa-cc-stripe font-24 text-primary"></i>
                                                    </div>

                                                    <div class="form-check form-check-inline font-16 mb-0">
                                                        <input id="BillingOptRadio1" class="form-check-input" type="radio" checked="@(BillingOption == PaymentMethod.Stripe)" name="billingOptions" @onchange="@(() => BillingOption = PaymentMethod.Stripe)" />
                                                        <label class="form-check-label" for="BillingOptRadio1">Pay with Stripe</label>
                                                    </div>
                                                    <p class="mb-0 ps-3 pt-1">You will be redirected to Stripe website to complete your purchase securely.</p>
                                                </div>


                                                <div class="border p-3 mb-3 rounded">
                                                    <div class="float-end">
                                                        <i class="fas fa-money-bill-alt font-24 text-primary"></i>
                                                    </div>
                                                    <div class="form-check form-check-inline font-16 mb-0">
                                                        <input id="BillingOptRadio3" class="form-check-input" type="radio" checked="@(BillingOption == PaymentMethod.CashOnDelivery)" name="billingOptions" @onchange="@(() => BillingOption = PaymentMethod.CashOnDelivery)" />
                                                        <label class="form-check-label" for="BillingOptRadio3">Cash on Delivery</label>
                                                    </div>
                                                    <p class="mb-0 ps-3 pt-1">Pay with cash when your order is delivered.</p>
                                                </div>
                                                <!-- end Cash on Delivery box-->
                                            </div>

                                            <div class="d-flex mb-3">
                                                <div class="">
                                                    @if (BillingInfo.ShipToDifferentAddress)
                                                    {
                                                        <button class="btn btn-custom" type="button" @onclick="()=>OnClick_BtnProceed(ProceedStatus.Shipping)"><i class="fas fa-arrow-left mx-2"></i> Back to Shipping </button>
                                                    }
                                                    else
                                                    {
                                                        <button class="btn btn-custom" type="button" @onclick="()=>OnClick_BtnProceed(ProceedStatus.Billing)"><i class="fas fa-arrow-left mx-2"></i> Back to Billing </button>
                                                    }
                                                </div>
                                                <div class="ml-auto">
                                                    <button class="btn btn-success" type="button" @onclick="()=>OnClick_BtnProceed(ProceedStatus.Payment)"><i class="fas fa-check-circle mx-2"></i> Place Order </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                            <div class="col-xl-4">
                                <div class="checkout-order-review">
                                    <div class="card mt-4 mt-xl-0">
                                        <div class="card-body">
                                            @if (CartItems == null)
                                            {
                                                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="100%" Height="500px" />
                                            }
                                            else
                                            {
                                                <h4 class="header-title mb-3">Order Summary</h4>

                                                <div class="table-responsive">
                                                    <table class="table table-centered table-nowrap mb-0">
                                                        <tbody>



                                                            @foreach (var cartItem in CartItems)
                                                            {
                                                                <tr>
                                                                    <td class="middle-product w-25">
                                                                        <img src="@cartItem.ProductImageSrc" alt="@cartItem.ProductName" title="@cartItem.ProductName" class="rounded" height="48">
                                                                    </td>
                                                                    <td class="w-50">
                                                                        <a href="javascript:void(0)" class="text-body fw-semibold">@cartItem.ProductName</a>
                                                                        <small class="d-block">@cartItem.ProductQuantity x <MudIcon Icon="@Icons.Material.Filled.CurrencyRupee" Title="Rupee" /> @cartItem.ProductPrice.ToString("F2")</small>
                                                                    </td>

                                                                    <td class="w-25 text-end">
                                                                        <MudIcon Icon="@Icons.Material.Filled.CurrencyRupee" Title="Rupee" /> @((cartItem.ProductQuantity * cartItem.ProductPrice).ToString("F2"))
                                                                    </td>
                                                                </tr>
                                                            }

                                                            <tr class="text-end">
                                                                <td colspan="2">
                                                                    <h6 class="m-0">Sub Total:</h6>
                                                                </td>
                                                                <td class="text-end">
                                                                    <MudIcon Icon="@Icons.Material.Filled.CurrencyRupee" Title="Rupee" /> @OrderSummary.GrandTotal.ToString("F2")
                                                                </td>
                                                            </tr>

                                                          
                                                            @if (OrderSummary.Discount != 0)
                                                            {
                                                                <tr class="text-end">
                                                                    <td colspan="2">
                                                                        <h6 class="m-0"> Discount :</h6>
                                                                    </td>
                                                                    <td class="text-end">
                                                                        - <MudIcon Icon="@Icons.Material.Filled.CurrencyRupee" Title="Rupee" /> @OrderSummary.Discount.ToString("F2")
                                                                    </td>
                                                                </tr>
                                                            }

                                                            @if (OrderSummary.ShippingCharge != 0)
                                                            {
                                                                <tr class="text-end">
                                                                    <td colspan="2">
                                                                        <h6 class="m-0">  Shipping Charge :</h6>
                                                                    </td>
                                                                    <td class="text-end">
                                                                        <MudIcon Icon="@Icons.Material.Filled.CurrencyRupee" Title="Rupee" /> @OrderSummary.ShippingCharge.ToString("F2")
                                                                    </td>
                                                                </tr>
                                                            }

                                                            <tr class="text-end">
                                                                <td colspan="2">
                                                                    <h6 class="m-0"> Estimated Tax :</h6>
                                                                </td>
                                                                <td class="text-end">
                                                                    <MudIcon Icon="@Icons.Material.Filled.CurrencyRupee" Title="Rupee" /> @OrderSummary.EstimatedTax.ToString("F2")
                                                                </td>
                                                            </tr>

                                                            <tr class="text-end">
                                                                <td colspan="2">
                                                                    <h5 class="m-0">Total:</h5>
                                                                </td>
                                                                <td class="text-end fw-semibold">
                                                                    <MudIcon Icon="@Icons.Material.Filled.CurrencyRupee" Title="Rupee" /> @OrderSummary.Total.ToString("F2")
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>https://0.0.0.0/#payment-info